
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Manual for the wai-annotations library for converting various annotation formats into each other">
      
      
      
        <link rel="canonical" href="https://ufdl.cms.waikato.ac.nz/wai-annotations-manual/plugin/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Plugin guide - wai-annotations manual</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#adding-components-to-wai-annotations-through-plugins" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="wai-annotations manual" class="md-header__button md-logo" aria-label="wai-annotations manual" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            wai-annotations manual
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Plugin guide
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="wai-annotations manual" class="md-nav__button md-logo" aria-label="wai-annotations manual" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    wai-annotations manual
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        Usage
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_formats/" class="md-nav__link">
        Format conversions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_audio/" class="md-nav__link">
        Audio processing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_imgaug/" class="md-nav__link">
        Image dataset augmentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_imgstats/" class="md-nav__link">
        Image dataset statistics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_imgvis/" class="md-nav__link">
        Image dataset visualizations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_video/" class="md-nav__link">
        Video handling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_redis_predictions/" class="md-nav__link">
        Predictions via Redis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples_generic/" class="md-nav__link">
        Generic plugin wrappers
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../architecture_overview/" class="md-nav__link">
        Architecture overview
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Plugin guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Plugin guide
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#adding-components-to-wai-annotations-through-plugins" class="md-nav__link">
    Adding components to wai-annotations through plugins
  </a>
  
    <nav class="md-nav" aria-label="Adding components to wai-annotations through plugins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generic-wrappers" class="md-nav__link">
    Generic wrappers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugin-types" class="md-nav__link">
    Plugin Types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domains" class="md-nav__link">
    Domains
  </a>
  
    <nav class="md-nav" aria-label="Domains">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stages" class="md-nav__link">
    Stages
  </a>
  
    <nav class="md-nav" aria-label="Stages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-input-stage" class="md-nav__link">
    Example Input Stage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-output-stage" class="md-nav__link">
    Example Output Stage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-processor-stage" class="md-nav__link">
    Example Processor Stage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practice" class="md-nav__link">
    Best Practice
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-command-line-options-to-plugin-components" class="md-nav__link">
    Adding Command-Line Options to Plugin Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splitting" class="md-nav__link">
    Splitting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../domains/" class="md-nav__link">
        Domains
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../plugins/" class="md-nav__link">
        Plugins
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../glossary/" class="md-nav__link">
        Glossary
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#adding-components-to-wai-annotations-through-plugins" class="md-nav__link">
    Adding components to wai-annotations through plugins
  </a>
  
    <nav class="md-nav" aria-label="Adding components to wai-annotations through plugins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#generic-wrappers" class="md-nav__link">
    Generic wrappers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plugin-types" class="md-nav__link">
    Plugin Types
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#domains" class="md-nav__link">
    Domains
  </a>
  
    <nav class="md-nav" aria-label="Domains">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stages" class="md-nav__link">
    Stages
  </a>
  
    <nav class="md-nav" aria-label="Stages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-input-stage" class="md-nav__link">
    Example Input Stage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-output-stage" class="md-nav__link">
    Example Output Stage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-processor-stage" class="md-nav__link">
    Example Processor Stage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practice" class="md-nav__link">
    Best Practice
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-command-line-options-to-plugin-components" class="md-nav__link">
    Adding Command-Line Options to Plugin Components
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#splitting" class="md-nav__link">
    Splitting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Plugin guide</h1>

<h2 id="adding-components-to-wai-annotations-through-plugins">Adding components to wai-annotations through plugins<a class="headerlink" href="#adding-components-to-wai-annotations-through-plugins" title="Permanent link">#</a></h2>
<p>wai-annotations uses a plugin system to allow other libraries to add new processing stages
without modifying the base library source. This document details how to go about using this system.</p>
<h3 id="generic-wrappers">Generic wrappers<a class="headerlink" href="#generic-wrappers" title="Permanent link">#</a></h3>
<p>If you just want to run some code that won't ever make it into a released plugin, then you might 
want to make use of the <a href="https://github.com/waikato-ufdl/wai-annotations-generic">wai.annotations.generic</a> 
module. This module provides wrappers around sources/ISPs/sinks, i.e., you only have to write the 
source/ISP/sink class itself but not all the other boiler plate code that will make your plugin 
available within the wai.annotations framework.</p>
<p>Check out the <a href="../examples_generic/">example section</a>. Also, the <a href="https://github.com/waikato-ufdl/wai-annotations-audio">wai.annotations.audio</a>
module has a more <a href="../examples_audio/">concrete example</a> for loading the <a href="https://urbansounddataset.weebly.com/urbansound8k.html">Urban8k</a> 
audio dataset with this wrapper approach.</p>
<h3 id="plugin-types">Plugin Types<a class="headerlink" href="#plugin-types" title="Permanent link">#</a></h3>
<p>There are 3 types of stage which can be added to wai-annotations via plugin: input formats, processing stages and output
formats. New domains can also be added, but these are specified indirectly via any of the previous components.</p>
<h3 id="domains">Domains<a class="headerlink" href="#domains" title="Permanent link">#</a></h3>
<p>New domains are added indirectly to wai-annotations as dependencies of components, as a domain which has no components
is essentially unreachable to a conversion chain. However, the specification of new domains is treated as a
plugin-related issue, so it is detailed here.</p>
<p>Definition of a new domain is a multi-step process, as follows.</p>
<ul>
<li>Define the type of the (unannotated) data for the domain, as a sub-class of <code>Data</code>. Objects of this class hold the
  name and binary data for an instance, along with any additional meta-data.</li>
<li>Define the type of the annotations for an instance in the domain. This can be any arbitrary type.</li>
<li>Define the type of instances in the domain as a sub-class of <code>Instance</code>. This represents the association between
  a data-item and its annotations. At its simplest, this is just a container for the data-item and the annotations, but
  additional meta-data about the relation can be added for specific domains, if required.</li>
<li>Define a specifier class for the domain, sub-classing <code>DomainSpecifier</code>. This advertises the domain to the
  wai-annotations framework.</li>
</ul>
<h4 id="example">Example<a class="headerlink" href="#example" title="Permanent link">#</a></h4>
<pre><code class="language-python">from typing import Type

# Import the base classes
from wai.annotations.core.domain import Data, Instance, DomainSpecifier

# Define the data-type which holds dataset item data
class MyDomainData(Data):
    @classmethod
    def from_file_data(cls, file_name: str, file_data: bytes) -&gt; 'MyFileInfo':
        # If we don't need any additional information, or it is calculated in the init method
        return cls(file_name, file_data)

# Define the type of annotations for the domain
class MyDomainAnnotations:
    ...

# Define an instance type, adding additional functionality, if required
class MyDomainInstance(Instance[MyDomainData, MyDomainAnnotations]):
    @classmethod
    def data_type(cls) -&gt; Type[MyDomainData]:
        return MyDomainData

    @classmethod
    def annotations_type(cls) -&gt; Type[MyDomainAnnotations]:
        return MyDomainAnnotations

    def additional_method(self):
        ...

# Define the domain specifier reporting the various classes for domain instances
class MyDomainSpecifier(DomainSpecifier):
    @classmethod
    def domain_name(cls) -&gt; str:
        return &quot;my domain&quot;

    @classmethod
    def description(cls) -&gt; str:
        return &quot;A detailed description of the domain&quot;

    @classmethod
    def data_type(cls) -&gt; Type[MyDomainData]:
        return MyDomainData

    @classmethod
    def annotations_type(cls) -&gt; Type[MyDomainAnnotations]:
        return MyDomainAnnotations

    @classmethod
    def instance_class(cls) -&gt; Type[MyDomainInstance]:
        return MyDomainInstance
</code></pre>
<h3 id="stages">Stages<a class="headerlink" href="#stages" title="Permanent link">#</a></h3>
<p>Stages are a partial pipeline of components. Input stages consist of a source component and zero or more processing
components, processing stages only consist of processing components, and output stages consist of zero or more
processing components followed by a sink component.</p>
<p>To create a new stage, the individual components must be created and then advertised through a stage specifier class. 
The base classes for components can be imported from wai-annotations' core package:</p>
<pre><code class="language-python">from wai.annotations.core.component import SourceComponent
from wai.annotations.core.component import ProcessorComponent
from wai.annotations.core.component import SinkComponent
</code></pre>
<p>Sub-class the base classes for the types of components you are trying to implement, and fill in the generic
type-parameters and abstract methods. See the examples below for guidance.</p>
<p>Then sub-class one of the stage-specifier classes for the type of stage you are creating:</p>
<pre><code class="language-python">from wai.annotations.core.specifier import SourceStageSpecifier
from wai.annotations.core.specifier import ProcessorStageSpecifier
from wai.annotations.core.specifier import SinkStageSpecifier
</code></pre>
<p>The specifier classes require that you override the <code>description</code> method, which provides a description of the stage,
and the <code>components</code> method, which lists the components which comprise the stage. Source/Sink stages also require a
<code>domain</code> method, which returns the domain that the stage reads/writes. Processor stages instead have a 
<code>domain_transfer_function</code> method, which returns the output domain for a given input domain (this way, processing
stages can be used in multiple domains).</p>
<p>In order for wai-annotations to recognise your plugin, the specifier class needs to be advertised as an entry point in
your setup script under the <code>wai.annotations.plugins</code> group:</p>
<pre><code class="language-python"># setup.py
from setuptools import setup

setup(
    ...,
    entry_points={
        &quot;wai.annotations.plugins&quot;: [
            # Input stage
            &quot;from-my-input-format=com.example.specifiers:MySourceStageSpecifier&quot;,

            # Output stage
            &quot;to-my-output-format=com.example.specifiers:MySinkStagepecifier&quot;,

            # Processor stages
            &quot;my-processor=com.example.specifiers:MyProcessorStageSpecifier&quot;
        ]
    }
)
</code></pre>
<h4 id="example-input-stage">Example Input Stage<a class="headerlink" href="#example-input-stage" title="Permanent link">#</a></h4>
<p>Input stages consist of a source component followed by zero or more processing components. Typically the source
component will be <code>wai.annotations.core.component.util.LocalFilenameSource</code>, but this is not required. What is
required is that the final component of the stage outputs instances in the domain that the stage operates.</p>
<pre><code class="language-python">from typing import Type, Tuple

from wai.annotations.core.component import SourceComponent, ProcessorComponent
from wai.annotations.domain.image.object_detection import (
  ImageObjectDetectionInstance, ImageObjectDetectionDomainSpecifier
)
from wai.annotations.core.specifier import SourceStageSpecifier
from wai.annotations.core.stream import ThenFunction, DoneFunction

# Define the source component (generic type is the type this source produces)
class MySourceComponent(SourceComponent[str]):
  # Any command-line options here...

  def produce(
          self,
          then: ThenFunction[str],
          done: DoneFunction
  ):
    # Call then(str) multiple times...
    ...

    # Call done()
    done()


# Define a processor component to parse each string from the source component into a domain instance
# (generic types are input and output type respectively)
class MyProcessorComponent(ProcessorComponent[str, ImageObjectDetectionInstance]):
  # Any command-line options here...

  def process_element(
          self,
          element: str,
          then: ThenFunction[ImageObjectDetectionInstance],
          done: DoneFunction
  ):
    # Parse each string and forward
    then(self._parse(element))

  def finish(
          self,
          then: ThenFunction[ImageObjectDetectionInstance],
          done: DoneFunction
  ):
    # Perform any clean-up
    ...

    # Call done
    done()

  def _parse(self, element: str) -&gt; ImageObjectDetectionInstance:
    # Parse the string into an instance
    ...

# Create the specifier class for the stage
class MySourceStageSpecifier(SourceStageSpecifier):
  @classmethod
  def description(cls) -&gt; str:
    return &quot;My source stage&quot;

  @classmethod
  def components(cls) -&gt; Tuple[Type[MySourceComponent], Type[MyProcessorComponent]]:
    return MySourceComponent, MyProcessorComponent

  @classmethod
  def domain(cls) -&gt; Type[ImageObjectDetectionDomainSpecifier]:
    return ImageObjectDetectionDomainSpecifier
</code></pre>
<h4 id="example-output-stage">Example Output Stage<a class="headerlink" href="#example-output-stage" title="Permanent link">#</a></h4>
<p>Output stages consist of zero or more processing components followed by a single sink component. The first component of
the stage must take instances in the stage's domain as input.</p>
<pre><code class="language-python">from typing import Type, Tuple

from wai.annotations.core.component import ProcessorComponent, SinkComponent
from wai.annotations.domain.image.object_detection import (
    ImageObjectDetectionInstance, ImageObjectDetectionDomainSpecifier
)
from wai.annotations.core.specifier import SinkStageSpecifier
from wai.annotations.core.stream import ThenFunction, DoneFunction

# Define a processor component to format each domain instance into a string
# (generic types are input and output type respectively)
class MyProcessorComponent(ProcessorComponent[ImageObjectDetectionInstance, str]):
    # Any command-line options here...

    def process_element(
            self,
            element: ImageObjectDetectionInstance,
            then: ThenFunction[str],
            done: DoneFunction
    ):
        # Format each instance and forward
        then(self._format(element))

    def finish(
            self,
            then: ThenFunction[ImageObjectDetectionInstance],
            done: DoneFunction
    ):
        # Perform any clean-up
        ...

        # Call done
        done()

    def _format(self, element: ImageObjectDetectionInstance) -&gt; str:
        # Format the instance into an str
        ...

# Define the sink component (generic type is the type this sink consumes)
class MySinkComponent(SinkComponent[str]):
  # Any command-line options here...

  def consume_element(self, element: str):
    # E.g. write the string to disk
    ...

  def finish(self):
    # Any tidy-up
    ...

# Create the specifier class for the stage
class MySinkStageSpecifier(SinkStageSpecifier):
    @classmethod
    def description(cls) -&gt; str:
        return &quot;My source stage&quot;

    @classmethod
    def components(cls) -&gt; Tuple[Type[MyProcessorComponent], Type[MySinkComponent]]:
        return  MyProcessorComponent, MySinkComponent

    @classmethod
    def domain(cls) -&gt; Type[ImageObjectDetectionDomainSpecifier]:
        return ImageObjectDetectionDomainSpecifier
</code></pre>
<h4 id="example-processor-stage">Example Processor Stage<a class="headerlink" href="#example-processor-stage" title="Permanent link">#</a></h4>
<p>Processor stages consist of one or more processing components. The domain-transfer function defined on the specifier
must match the input/output types of the chain of components for the stage.</p>
<pre><code class="language-python">from typing import Type, Tuple

from wai.annotations.core.component import ProcessorComponent
from wai.annotations.core.domain import Instance, DomainSpecifier
from wai.annotations.core.specifier import ProcessorStageSpecifier
from wai.annotations.core.stream import ThenFunction, DoneFunction
from wai.annotations.core.stream.util import ProcessState

# Define a processor component to remove every second instance (for any domain)
# (generic types are input and output type respectively)
class MyProcessorComponent(ProcessorComponent[Instance, Instance]):
    # Any command-line options here...

    # Process-state to track whether we need to remove the next instance
    remove_next: bool = ProcessState(lambda self: False)

    def process_element(
            self,
            element: Instance,
            then: ThenFunction[Instance],
            done: DoneFunction
    ):
        if not self.remove_next:
            then(element)

        self.remove_next = not self.remove_next

    def finish(
            self,
            then: ThenFunction[Instance],
            done: DoneFunction
    ):
        # Perform any clean-up
        ...

        # Call done
        done()

# Create the specifier class for the stage
class MyProcessorStageSpecifier(ProcessorStageSpecifier):
    @classmethod
    def description(cls) -&gt; str:
        return &quot;My source stage&quot;

    @classmethod
    def components(cls) -&gt; Tuple[Type[MyProcessorComponent]]:
        return MyProcessorComponent,

    @classmethod
    def domain_transfer_function(
            cls,
            input_domain: Type[DomainSpecifier]
    ) -&gt; Type[DomainSpecifier]:
        # Because our processor stage works in any domain, and does not cross domains, just return the input domain
        return input_domain
</code></pre>
<h4 id="best-practice">Best Practice<a class="headerlink" href="#best-practice" title="Permanent link">#</a></h4>
<p>Although in each of the examples shown here, we have defined our plugin specifiers in the same file as the components
they advertise, this is not the recommended approach. The specifier types should instead be defined in their own
sub-package, and the methods should locally import the specified types (instead of globally at the beginning of the
specifier Python file). This is so the specifier can be imported into the plugin system without importing potentially
heavy-weight libraries that the components depend on for their functionality. This way the system can provide reflection
of the available plugins, but only load those plugins that are actually selected for use in a conversion.</p>
<h3 id="adding-command-line-options-to-plugin-components">Adding Command-Line Options to Plugin Components<a class="headerlink" href="#adding-command-line-options-to-plugin-components" title="Permanent link">#</a></h3>
<p>See <a href="../cli/">here</a> for a description of command-line option support in wai-annotations.</p>
<h3 id="splitting">Splitting<a class="headerlink" href="#splitting" title="Permanent link">#</a></h3>
<p>Sink-components (and by extension sink-stages) may require that the incoming instances be split across a number of
output locations. Special support for splitting is provided in the <code>wai.annotations.core.component.util</code> sub-package.
See <a href="../component_util/#Splitting">here</a> for information on how to add splitting to your sink-stages.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../architecture_overview/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Architecture overview" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Architecture overview
            </div>
          </div>
        </a>
      
      
        
        <a href="../domains/" class="md-footer__link md-footer__link--next" aria-label="Next: Domains" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Domains
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
    
  </body>
</html>